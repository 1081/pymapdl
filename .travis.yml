# -*- coding: utf-8 -*-
# :Project:   pyansys -- Configuration to build and upload Linux wheels to PyPI
# :Author:    Alex Kaszynski <akascap@gmail.com>
# :License:   MIT License

# borrowed parts from
# https://github.com/python-rapidjson/python-rapidjson/blob/master/.appveyor.yml

# Builds wheels for Linux using cibuildwheel, inside the manylinux1 Docker image.
# builds 64-bit Python 2.7, Python3.5, Python3.6, Python3.7

dist: xenial

matrix:
  include:
    - sudo: required
      language: python
      python: "3.6"
      services:
        - docker
      env: PIP=pip
    - os: osx
      osx_image: xcode8.3

# addons:
#   apt:
#     packages:
#       - xvfb

# before_script: # configure a headless display to test plot generation
#   - export DISPLAY=:99.0
#   - which Xvfb
#   - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
#   # - ls -l /etc/init.d/
#   # - sh -e /etc/init.d/xvfb start
#   - sleep 3 # give xvfb some time to start

env:
  global:
    - CIBW_BEFORE_BUILD_LINUX="pip install numpy==1.15.0; pip install cython;pip install pymeshfix; yum install libXt -y"
    - CIBW_BEFORE_BUILD_MACOS="pip install numpy==1.15.0; pip install cython; pip install pymeshfix"
    - CIBW_TEST_REQUIRES="pytest scipy matplotlib"
    - CIBW_TEST_COMMAND="pytest {project}/tests"  # fails to include libaries from vtk
    - CIBW_SKIP="cp27-* cp34-* *manylinux1_i686*"
CIBW_SKIP:
    - TWINE_USERNAME=akaszynski
      # Note: TWINE_PASSWORD is set in Travis settings

# before_install:
#   # configure a headless display
#   - git clone --depth 1 git://github.com/pyvista/gl-ci-helpers.git
#   - source ./gl-ci-helpers/travis/setup_headless_display.sh

install:
  # Setup for python 3 wheels in Mac OS X
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      brew update
      brew upgrade python
      # CFLAGS='-stdlib=libc++'
    fi;
  - pip3 install --upgrade cibuildwheel


script:
  - $PIP install cibuildwheel
  - cibuildwheel --output-dir wheelhouse
  - if [ "${TRAVIS_TAG:-}" != "" ]; then
      python3 setup.py sdist;
      cp dist/*.tar.gz wheelhouse/;
      pip3 install twine;
      python3 -m twine upload --skip-existing wheelhouse/*;
    fi

notifications:
  email: false
